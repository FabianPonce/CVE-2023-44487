FROM ubuntu AS build
ARG NGINX_VERSION=1.25.0
RUN apt-get update && \
    apt-get install -y mercurial curl build-essential libpcre3-dev libssl-dev zlib1g-dev libnet-dns-perl && \
    cpan -T -i Test::More && \
    cd /tmp && \
    curl -L https://nginx.org/download/nginx-$NGINX_VERSION.tar.gz -o nginx.tar.gz && \
    tar xvf nginx.tar.gz && \
    cd nginx-$NGINX_VERSION && \
    ./configure --prefix=/usr/local/nginx --with-http_v2_module --with-http_ssl_module && \
    make && \
    make install 

FROM ubuntu
RUN apt-get update && \
    apt-get install -y libpcre3 libssl3 zlib1g
COPY --from=build /usr/local/nginx /usr/local/nginx
# test for linking errors
RUN /usr/local/nginx/sbin/nginx -V

COPY nginx.conf /usr/local/nginx/conf
COPY cert.key /
COPY cert.pem /

CMD /usr/local/nginx/sbin/nginx